<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 
        CATATAN:
        Ini adalah file BARU yang menggunakan SUPABASE.
        Kunci dan URL Anda sudah saya masukkan di bagian bawah.
    -->
    <title>Sistem Stok (Supabase) - Redesma</title>
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 3. Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- 4. Font Inter -->
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hidden { display: none; }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Container Utama -->
    <div class="container mx-auto p-4 md:p-8">

        <!-- Loading Spinner -->
        <div id="loading-spinner" class="fixed inset-0 z-50 flex items-center justify-center bg-white bg-opacity-75">
            <div class="loader"></div>
        </div>

        <!-- Pesan Error/Notifikasi -->
        <div id="message-box" class="hidden fixed top-5 right-5 z-50 p-4 rounded-lg shadow-md max-w-sm"></div>

        <!-- ====================================================== -->
        <!-- Halaman 1 & 2: Otorisasi (Login & Register)            -->
        <!-- ====================================================== -->
        <div id="auth-container" class="hidden max-w-md mx-auto mt-10">
            <div class="bg-white p-8 rounded-lg shadow-lg">
                <img src="https://placehold.co/300x80/003366/FFFFFF?text=Perusahaan+Redesma" alt="Logo Perusahaan Redesma" class="mx-auto mb-6 rounded">
                
                <!-- Form Login -->
                <form id="login-form">
                    <h2 class="text-2xl font-bold text-center text-gray-700 mb-6">Login Sistem Stok</h2>
                    <div class="mb-4">
                        <label for="login-email" class="block text-sm font-medium text-gray-600 mb-2">Email</label>
                        <input type="email" id="login-email" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-sm font-medium text-gray-600 mb-2">Password</label>
                        <input type="password" id="login-password" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition duration-200">
                        Masuk
                    </button>
                    <p class="text-center text-sm text-gray-500 mt-4">
                        Belum punya akun? 
                        <a href="#" id="show-register" class="text-blue-600 hover:underline">Daftar di sini</a>
                    </p>
                </form>

                <!-- Form Register (disembunyikan awalnya) -->
                <form id="register-form" class="hidden">
                    <h2 class="text-2xl font-bold text-center text-gray-700 mb-6">Daftar Akun Baru</h2>
                    <div class="mb-4">
                        <label for="register-email" class="block text-sm font-medium text-gray-600 mb-2">Email</label>
                        <input type="email" id="register-email" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="mb-6">
                        <label for="register-password" class="block text-sm font-medium text-gray-600 mb-2">Password</label>
                        <input type="password" id="register-password" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition duration-200">
                        Daftar
                    </button>
                    <p class="text-center text-sm text-gray-500 mt-4">
                        Sudah punya akun? 
                        <a href="#" id="show-login" class="text-blue-600 hover:underline">Login di sini</a>
                    </p>
                </form>
            </div>
        </div>

        <!-- ====================================================== -->
        <!-- Halaman 3: Dashboard Stok (Hanya untuk yg sudah login) -->
        <!-- ====================================================== -->
        <div id="dashboard-container" class="hidden">
            <!-- Header Dashboard -->
            <header class="flex flex-wrap justify-between items-center mb-6 p-4 bg-white rounded-lg shadow">
                <h1 class="text-3xl font-bold text-blue-800">Dashboard Stok Redesma</h1>
                <div>
                    <span id="user-email" class="text-gray-600 mr-4"></span>
                    <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg transition duration-200">
                        Logout
                    </button>
                </div>
            </header>

            <!-- Chart (Grafik Stok) -->
            <div class="bg-white p-6 rounded-lg shadow mb-6">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Grafik Stok Barang (Saat Ini)</h2>
                <div class="h-64 md:h-80">
                    <canvas id="inventoryChart"></canvas>
                </div>
            </div>

            <!-- Form Input Data -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Form Barang Masuk -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-semibold mb-4 text-green-700">Input Barang Masuk</h2>
                    <form id="form-barang-masuk" class="space-y-4">
                        <div>
                            <label for="masuk-id" class="block text-sm font-medium text-gray-600">ID Barang</label>
                            <input type="text" id="masuk-id" placeholder="Contoh: B001, A002" required class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label for="masuk-kuantitas" class="block text-sm font-medium text-gray-600">Kuantitas</labe>
                            <input type="number" id="masuk-kuantitas" min="1" required class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                            Tambah Masuk
                        </button>
                    </form>
                </div>
                
                <!-- Form Barang Keluar -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-semibold mb-4 text-red-700">Input Barang Keluar</h2>
                    <form id="form-barang-keluar" class="space-y-4">
                        <div>
                            <label for="keluar-id" class="block text-sm font-medium text-gray-600">ID Barang</label>
                            <input type="text" id="keluar-id" placeholder="Contoh: B001, A002" required class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                        </div>
                        <div>
                            <label for="keluar-kuantitas" class="block text-sm font-medium text-gray-600">Kuantitas</label>
                            <input type="number" id="keluar-kuantitas" min="1" required class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                        </div>
                        <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                            Tambah Keluar
                        </button>
                    </form>
                </div>
            </div>

            <!-- Tabel Data -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Tabel Barang Masuk -->
                <div class="bg-white p-6 rounded-lg shadow overflow-x-auto">
                    <h2 class="text-xl font-semibold mb-4 text-green-700">Data Barang Masuk</h2>
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Barang</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kuantitas</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal Masuk</th>
                            </tr>
                        </thead>
                        <tbody id="table-barang-masuk" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="4" class="p-4 text-center text-gray-500">Memuat data...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Tabel Barang Keluar -->
                <div class="bg-white p-6 rounded-lg shadow overflow-x-auto">
                    <h2 class="text-xl font-semibold mb-4 text-red-700">Data Barang Keluar</h2>
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Barang</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kuantitas</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal Keluar</th>
                            </tr>
                        </thead>
                        <tbody id="table-barang-keluar" class="bg-white divide-y divide-gray-200">
                             <tr><td colspan="4" class="p-4 text-center text-gray-500">Memuat data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div> <!-- Akhir Dashboard Container -->

    </div> <!-- Akhir Container Utama -->


    <!-- ====================================================== -->
    <!-- JavaScript & Supabase                                  -->
    <!-- ====================================================== -->
    <script type="module">
        // 4. Supabase Import
        // Ini berfungsi karena kita sudah memuat script Supabase di <head>
        const { createClient } = supabase;

        
        // ===================================================================
        // $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
        //
        //          KONFIGURASI SUPABASE ANDA SUDAH SAYA MASUKKAN
        //
        // $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
        // ===================================================================

        const supabaseUrl = "https://kcwxjwtvjsdgobeygiau.supabase.co"; // <-- SUDAH DISET
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtjd3hqd3R2anNkZ29iZXlnaWF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzMjMxNzMsImV4cCI6MjA3ODg5OTE3M30.BW7hqJIp1gbUejDNKVaf6A1jhz4bIXIFVCzztoiwuZU"; // <-- SUDAH DISET
        
        // ===================================================================
        // $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
        // ===================================================================


        // Inisialisasi Supabase
        const db = createClient(supabaseUrl, supabaseKey);
        console.log('Supabase client initialized');

        // Variabel Global
        let currentChart = null; // Menyimpan instance chart
        let realtimeChannel = null; // Menyimpan channel realtime

        // DOM Elements
        const loadingSpinner = document.getElementById('loading-spinner');
        const authContainer = document.getElementById('auth-container');
        const dashboardContainer = document.getElementById('dashboard-container');
        const messageBox = document.getElementById('message-box');
        
        // Auth Forms
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegisterLink = document.getElementById('show-register');
        const showLoginLink = document.getElementById('show-login');
        
        // Dashboard Elements
        const userEmailDisplay = document.getElementById('user-email');
        const logoutButton = document.getElementById('logout-button');
        const chartCanvas = document.getElementById('inventoryChart').getContext('2d');
        
        // Data Forms
        const formBarangMasuk = document.getElementById('form-barang-masuk');
        const formBarangKeluar = document.getElementById('form-barang-keluar');

        // Data Tables
        const tableBarangMasuk = document.getElementById('table-barang-masuk');
        const tableBarangKeluar = document.getElementById('table-barang-keluar');

        // === Fungsi Helper ===
        
        /** Menampilkan pesan notifikasi */
        function showMessage(message, isError = false) {
            messageBox.textContent = message;
            messageBox.className = 'hidden'; // Reset
            messageBox.classList.add(isError ? 'bg-red-200' : 'bg-green-200');
            messageBox.classList.add(isError ? 'text-red-800' : 'text-green-800');
            messageBox.classList.remove('hidden');
            
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000);
        }

        /** Memformat obyek Tanggal (dari string ISO Supabase) menjadi string yang rapi */
        function formatTanggal(tanggalString) {
            if (!tanggalString) return 'N/A';
            const date = new Date(tanggalString); 
            return date.toLocaleString('id-ID', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // === Fungsi Logika Utama ===

        /** Mengambil SEMUA data dari database sekaligus */
        async function fetchAllData() {
            console.log("Fetching all data...");
            try {
                // Ambil data masuk dan keluar secara paralel
                const [masukResponse, keluarResponse] = await Promise.all([
                    db.from('barang_masuk').select('*').order('tanggal', { ascending: false }),
                    db.from('barang_keluar').select('*').order('tanggal', { ascending: false })
                ]);

                if (masukResponse.error) throw masukResponse.error;
                if (keluarResponse.error) throw keluarResponse.error;

                const dataMasuk = masukResponse.data;
                const dataKeluar = keluarResponse.data;

                // Render data ke UI
                renderTabelMasuk(dataMasuk);
                renderTabelKeluar(dataKeluar);
                updateChart(dataMasuk, dataKeluar);

            } catch (error) {
                console.error("Error fetching data:", error);
                showMessage(`Gagal memuat data: ${error.message}`, true);
            }
        }
        
        /**
         * Mengatur "pendengar" (listener) data real-time dari Supabase.
         */
        function setupDataListeners() {
            // Hentikan listener lama jika ada
            if (realtimeChannel) {
                realtimeChannel.unsubscribe();
            }
            
            console.log("Setting up realtime listeners...");
            
            realtimeChannel = db.channel('public-changes')
                .on('postgres_changes', { 
                    event: 'INSERT', 
                    schema: 'public', 
                    table: 'barang_masuk' 
                }, (payload) => {
                    console.log('Perubahan barang_masuk terdeteksi!', payload);
                    showMessage("Data masuk baru terdeteksi, memuat ulang...", false);
                    fetchAllData(); // Ambil ulang semua data
                })
                .on('postgres_changes', { 
                    event: 'INSERT', 
                    schema: 'public', 
                    table: 'barang_keluar' 
                }, (payload) => {
                    console.log('Perubahan barang_keluar terdeteksi!', payload);
                    showMessage("Data keluar baru terdeteksi, memuat ulang...", false);
                    fetchAllData(); // Ambil ulang semua data
                })
                .subscribe((status, err) => {
                    if (status === 'SUBSCRIBED') {
                        console.log('Berhasil terhubung ke Realtime Supabase!');
                    }
                    if (status === 'CHANNEL_ERROR') {
                        console.error('Realtime connection error:', err);
                    }
                });
        }

        /** Menghentikan semua listener data (saat logout) */
        function cleanupListeners() {
            if (realtimeChannel) {
                realtimeChannel.unsubscribe();
                realtimeChannel = null;
                console.log("Realtime listeners stopped.");
            }
        }

        /** Render data ke tabel barang masuk */
        function renderTabelMasuk(data) {
            tableBarangMasuk.innerHTML = '';
            if (!data || data.length === 0) {
                tableBarangMasuk.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">Belum ada data</td></tr>';
                return;
            }
            // Data sudah diurutkan dari query
            data.forEach((item, index) => {
                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${index + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap font-medium">${item.id_barang}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-green-600 font-bold">+${item.kuantitas}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatTanggal(item.tanggal)}</td>
                    </tr>
                `;
                tableBarangMasuk.innerHTML += row;
            });
        }

        /** Render data ke tabel barang keluar */
        function renderTabelKeluar(data) {
            tableBarangKeluar.innerHTML = '';
            if (!data || data.length === 0) {
                tableBarangKeluar.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">Belum ada data</td></tr>';
                return;
            }
            // Data sudah diurutkan dari query
            data.forEach((item, index) => {
                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${index + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap font-medium">${item.id_barang}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-red-600 font-bold">-${item.kuantitas}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatTanggal(item.tanggal)}</td>
                    </tr>
                `;
                tableBarangKeluar.innerHTML += row;
            });
        }

        /** Mengolah data dan memperbarui chart */
        function updateChart(dataMasuk, dataKeluar) {
            const stokAkhir = {};

            // 1. Hitung total barang masuk
            (dataMasuk || []).forEach(item => {
                const id = item.id_barang.toUpperCase();
                stokAkhir[id] = (stokAkhir[id] || 0) + item.kuantitas;
            });

            // 2. Kurangi dengan total barang keluar
            (dataKeluar || []).forEach(item => {
                const id = item.id_barang.toUpperCase();
                stokAkhir[id] = (stokAkhir[id] || 0) - item.kuantitas;
            });

            // 3. Siapkan data untuk Chart.js
            const labels = Object.keys(stokAkhir).sort();
            const data = labels.map(id => stokAkhir[id]);

            if (currentChart) {
                currentChart.destroy();
            }

            currentChart = new Chart(chartCanvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Stok Barang Saat Ini',
                        data: data,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }


        // === Event Listener ===

        // Pengatur utama status login
        db.auth.onAuthStateChange((event, session) => {
            if (session) {
                // User sudah login
                const user = session.user;
                console.log("User logged in:", user.email);
                authContainer.classList.add('hidden');
                dashboardContainer.classList.remove('hidden');
                userEmailDisplay.textContent = user.email;
                
                // Ambil data awal & mulai dengarkan perubahan
                fetchAllData();
                setupDataListeners();

            } else {
                // User belum login (atau sudah logout)
                console.log("User logged out");
                authContainer.classList.remove('hidden');
                dashboardContainer.classList.add('hidden');
                userEmailDisplay.textContent = '';
                
                // Hentikan mendengarkan data
                cleanupListeners();
                
                // Bersihkan tabel & chart
                if (currentChart) currentChart.destroy();
                tableBarangMasuk.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">Silakan login</td></tr>';
                tableBarangKeluar.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">Silakan login</td></tr>';
            }
            loadingSpinner.classList.add('hidden');
        });

        // Toggle Form Login/Register
        showRegisterLink.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
        });

        showLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
        });

        // Handle Register
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            loadingSpinner.classList.remove('hidden');

            try {
                const { error } = await db.auth.signUp({ email, password });
                if (error) throw error;
                // Supabase otomatis mengirim email konfirmasi. 
                showMessage("Akun berhasil dibuat! Silakan cek email Anda untuk konfirmasi.", false);
            } catch (error) {
                console.error("Register error:", error);
                showMessage(`Gagal mendaftar: ${error.message}`, true);
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        });

        // Handle Login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            loadingSpinner.classList.remove('hidden');

            try {
                const { error } = await db.auth.signInWithPassword({ email, password });
                if (error) throw error;
                // onAuthStateChange akan otomatis menangani sisanya
                showMessage("Login berhasil!", false);
            } catch (error) {
                console.error("Login error:", error);
                showMessage(`Gagal login: ${error.message}`, true);
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        });

        // Handle Logout
        logoutButton.addEventListener('click', async () => {
            loadingSpinner.classList.remove('hidden');
            try {
                const { error } = await db.auth.signOut();
                if (error) throw error;
                // onAuthStateChange akan otomatis menangani sisanya
                showMessage("Anda telah logout.", false);
            } catch (error) {
                console.error("Logout error:", error);
                showMessage(`Gagal logout: ${error.message}`, true);
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        });

        // Handle Form Barang Masuk
        formBarangMasuk.addEventListener('submit', async (e) => {
            e.preventDefault();
            const idBarang = document.getElementById('masuk-id').value;
            const kuantitas = parseInt(document.getElementById('masuk-kuantitas').value);
            
            // Ambil ID user yang sedang login
            const { data: { user } } = await db.auth.getUser();
            if (!user) {
                showMessage("Sesi Anda berakhir, silakan login ulang.", true);
                return;
            }

            try {
                const { error } = await db.from('barang_masuk').insert({ 
                    id_barang: idBarang.toUpperCase(), 
                    kuantitas: kuantitas,
                    user_id: user.id // Simpan siapa yg input
                });
                if (error) throw error;
                
                showMessage("Data barang masuk berhasil ditambah!", false);
                formBarangMasuk.reset();
                // Fitur Realtime akan otomatis mengambil data baru
            } catch (error) {
                console.error("Error add barang masuk:", error);
                showMessage(`Gagal simpan data: ${error.message}`, true);
            }
        });

        // Handle Form Barang Keluar
        formBarangKeluar.addEventListener('submit', async (e) => {
            e.preventDefault();
            const idBarang = document.getElementById('keluar-id').value;
            const kuantitas = parseInt(document.getElementById('keluar-kuantitas').value);
            
            const { data: { user } } = await db.auth.getUser();
            if (!user) {
                showMessage("Sesi Anda berakhir, silakan login ulang.", true);
                return;
            }

            try {
                // Validasi stok sebelum mengurangi
                const idBarangUpper = idBarang.toUpperCase();
                
                // Ambil total masuk untuk barang ini
                const { data: dataMasuk, error: errMasuk } = await db.from('barang_masuk')
                    .select('kuantitas')
                    .eq('id_barang', idBarangUpper);
                if (errMasuk) throw errMasuk;

                // Ambil total keluar untuk barang ini
                const { data: dataKeluar, error: errKeluar } = await db.from('barang_keluar')
                    .select('kuantitas')
                    .eq('id_barang', idBarangUpper);
                if (errKeluar) throw errKeluar;

                let totalMasuk = 0;
                (dataMasuk || []).forEach(item => { totalMasuk += item.kuantitas; });
                
                let totalKeluar = 0;
                (dataKeluar || []).forEach(item => { totalKeluar += item.kuantitas; });

                const stokSaatIni = totalMasuk - totalKeluar;
                
                // Cek apakah stok mencukupi
                if (kuantitas > stokSaatIni) {
                    showMessage(`Gagal: Stok ${idBarangUpper} tidak cukup. Stok saat ini: ${stokSaatIni}`, true);
                    return; // Hentikan proses jika stok tidak cukup
                }

                // Jika stok cukup, lanjutkan proses insert
                const { error } = await db.from('barang_keluar').insert({ 
                    id_barang: idBarangUpper, 
                    kuantitas: kuantitas,
                    user_id: user.id
                });
                if (error) throw error;
                
                showMessage("Data barang keluar berhasil ditambah!", false);
                formBarangKeluar.reset();
                // Fitur Realtime akan otomatis mengambil data baru
            } catch (error) {
                console.error("Error add barang keluar:", error);
                showMessage(`Gagal simpan data: ${error.message}`, true);
            }
        });

    </script>
</body>
</html>